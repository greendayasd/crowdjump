<div ng-controller="ChatController as vm" ng-show="vm.isAuthenticated">
    {#        {% if first_message_id > 0 %}#}
    {#            <div class="text-center">#}
    {#                <button id="load_old_messages" class="btn btn-success">Load old messages</button>#}
    {#            </div>#}
    {#        {% endif %}#}
    <div class="col-md-12" id="all_messages">
        <div ng-repeat="message in chatMessages" id="chat">
            <div style="background-color: white">
                <strong>{{ message.user.username }}:</strong> {{ message.message }}

            </div>
        </div>
    </div>
    <div ng-show="chatMessages.length < 1">
        <div id="no_messages">No messages here</div>
    </div>
</div>
{#    <textarea id="chat-log" cols="96" rows="20" size="100"#}
{#              style="resize: none; width: 100%;height: 30%"></textarea><br/>#}
{#    <input id="chat-message-input" type="text" style="width: 100%;height: 30%"/><br/>#}
<div class="row">
    <form id="chatform">
        <div class="">
            <input id="chat-message-input" type="text" class="form-control input-lg"
                   placeholder="Type chat message here"
                   required>
        </div>
        <div class="col-xs-2 col-sm-1">
            <button id="chat-message-submit" type="button" class="btn btn-primary input-lg" value="Send"
                    style="visibility:hidden">Submit
            </button>
        </div>

        {#        <input id="chat-message-submit" type="button" class="btn-primary" value="Send"/>#}
    </form>
</div>
<script>

    var roomName = '123';

    var ws_scheme = 'wss'; //window.location.protocol == "https:" ? "wss" : "ws";

    var port = ':8001';
    if (window.location.host == "localhost:8000") {
        ws_scheme = 'ws';
        port = '';
    }
    var chatSocket = new WebSocket(
        ws_scheme + '://' + window.location.host + port +
        '/ws/chat/' + roomName + '/');

    {#chatSocket.onmessage = function (e) {#}
    {#    var data = JSON.parse(e.data);#}
    {#    var message = data['message'];#}
    {#    var datetime = data['datetime'];#}
    {#    var username = data['username'];#}
    {#    document.querySelector('#chat-log').value += (datetime + '  ' + username + ":  " + message + '\n');#}
    {# }; #}

    chatSocket.onmessage = function (message) {

        if ($("#no_messages").length) {
            $("#no_messages").remove();
        }

        var data = JSON.parse(message.data);
        var chat = $("#chat")
        var ele = $('<li class="list-group-item"></li>')

        ele.append(
            data.datetime + ' <strong>' + data.username + '</strong> : ')

        ele.append(
            data.message)

        chat.append(ele)
        $('#all_messages').scrollTop($('#all_messages')[0].scrollHeight);
    };


    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };
    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        var datetime = new Date().format('d-m-Y h:i:s');
        {#var username = 'test'; //{{ user.id }};#}

        chatSocket.send(JSON.stringify({
            'message': message,
            'datetime': datetime
        }));

        messageInputDom.value = '';
    };
</script>